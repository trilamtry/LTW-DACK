@model IEnumerable<FashionStore.Models.Product>

@{
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    ViewBag.Title = "Quản lý Sản phẩm";
    var cultureInfo = new System.Globalization.CultureInfo("vi-VN");
}

<div class="main-content flex-grow-1 p-3 p-md-4">
    <h1 class="mb-4">
        <i class="bi bi-box-seam me-2"></i>Quản lý Sản phẩm
    </h1>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Danh sách Sản phẩm</h5>
            <a href="@Url.Action("Create", "Product", new { area = "Admin" })" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Thêm mới Sản phẩm
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Ảnh</th>
                            <th>Tên Sản phẩm</th>
                            <th>Danh mục</th>
                            <th>Giá gốc</th>
                            <th>Tổng Tồn kho</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            // Tính tổng tồn kho từ các biến thể (ProductVariant)
                            int totalStock = item.ProductVariants?.Sum(v => v.Stock) ?? 0;

                            // Lấy ảnh chính (IsPrimary = 1) hoặc ảnh đầu tiên
                            var primaryImage = item.ProductImages?.FirstOrDefault(img => img.IsPrimary) ?? item.ProductImages?.FirstOrDefault();

                            <tr>
                                <td>@item.ProductId</td>
                                <td>
                                    @if (primaryImage != null)
                                    {
                                        <img src="@Url.Content("~/assets/img/product/" + primaryImage.ImageUrl)" alt="@item.ProductName" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" />
                                    }
                                    else
                                    {
                                        <span>N/A</span>
                                    }
                                </td>
                                <td>
                                    <strong>@item.ProductName</strong>
                                    <br /><small class="text-muted">Mã: @item.SKU</small>
                                </td>
                                <td>
                                    @* Hiển thị danh mục đơn (Many-to-One) *@
                                    @if (item.Category != null)
                                    {
                                        <span class="badge bg-secondary">@item.Category.CategoryName</span>
                                    }
                                </td>
                                <td>@item.BasePrice.ToString("N0", cultureInfo) đ</td>
                                <td>
                                    <span class="badge @(totalStock < 20 ? "bg-danger" : "bg-success")">
                                        @totalStock
                                    </span>
                                </td>
                                <td>
                                    <span class="badge @(item.IsActive ? "bg-success" : "bg-danger")">
                                        @(item.IsActive ? "Đang bán" : "Ngừng bán")
                                    </span>
                                </td>
                                <td>@item.CreatedAt.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <a href="@Url.Action("Index", "ProductVariant", new { productId = item.ProductId, area = "Admin" })" class="btn btn-sm btn-outline-dark me-1" title="Quản lý biến thể & Kho">
                                        <i class="bi bi-box-seam"></i> <span class="d-none d-md-inline">Kho</span>
                                    </a>
                                    <a href="@Url.Action("Edit", "Product", new { id = item.ProductId, area = "Admin" })" class="btn btn-sm btn-outline-info me-1" title="Sửa">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <a href="@Url.Action("Delete", "Product", new { id = item.ProductId, area = "Admin" })" class="btn btn-sm btn-outline-danger" title="Xóa">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <p class="text-muted mb-0">Hiển thị @Model.Count() sản phẩm.</p>
        </div>
    </div>
</div>